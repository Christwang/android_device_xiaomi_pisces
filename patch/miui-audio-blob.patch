commit 2b6bb7f3010fd560a6570ee7fa5f2c4f9d728ec0
Author: Xuefer <xuefer@gmail.com>
Date:   Wed Mar 4 17:42:15 2015 +0800

    miui audio blob support
    
    Change-Id: Ia63f813321250df800adf5a9ea5b59bdc53fde38

diff --git a/services/audiopolicy/AudioPolicyClientImplLegacy.cpp b/services/audiopolicy/AudioPolicyClientImplLegacy.cpp
index 36c85f1..e457696 100644
--- a/frameworks/av/services/audiopolicy/AudioPolicyClientImplLegacy.cpp
+++ b/frameworks/av/services/audiopolicy/AudioPolicyClientImplLegacy.cpp
@@ -316,6 +316,22 @@ int aps_set_voice_volume(void *service, float volume, int delay_ms)
     return audioPolicyService->setVoiceVolume(volume, delay_ms);
 }
 
+#ifdef HAVE_MIUI_AUDIO_BLOB
+int aps_set_mode(void *service, audio_mode_t mode, int unknown)
+{
+    AudioPolicyService *audioPolicyService = (AudioPolicyService *)service;
+
+    return audioPolicyService->setMode(mode, unknown);
+}
+
+int aps_set_fm_volume(void *service, float volume, int delay_ms)
+{
+    AudioPolicyService *audioPolicyService = (AudioPolicyService *)service;
+
+    return audioPolicyService->setFmVolume(volume, delay_ms);
+}
+#endif
+
 }; // extern "C"
 
 }; // namespace android
diff --git a/services/audiopolicy/AudioPolicyService.cpp b/services/audiopolicy/AudioPolicyService.cpp
index 3079454..f5b4f8f 100644
--- a/frameworks/av/services/audiopolicy/AudioPolicyService.cpp
+++ b/frameworks/av/services/audiopolicy/AudioPolicyService.cpp
@@ -997,6 +997,20 @@ int AudioPolicyService::setVoiceVolume(float volume, int delayMs)
     return (int)mAudioCommandThread->voiceVolumeCommand(volume, delayMs);
 }
 
+#ifdef HAVE_MIUI_AUDIO_BLOB
+int AudioPolicyService::setMode(audio_mode_t mode, int unknown)
+{
+    ALOGD("unsupported AudioPolicyService::setMode(%d, %d)", (int) mode, unknown);
+    return PERMISSION_DENIED;
+}
+
+int AudioPolicyService::setFmVolume(float volume, int delayMs)
+{
+    ALOGD("unsupported AudioPolicyService::setFmVolume(%f, %d)", (double) volume, delayMs);
+    return PERMISSION_DENIED;
+}
+#endif
+
 extern "C" {
 audio_module_handle_t aps_load_hw_module(void *service __unused,
                                              const char *name);
@@ -1051,6 +1065,10 @@ int aps_start_tone(void *service, audio_policy_tone_t tone,
                               audio_stream_type_t stream);
 int aps_stop_tone(void *service);
 int aps_set_voice_volume(void *service, float volume, int delay_ms);
+#ifdef HAVE_MIUI_AUDIO_BLOB
+int aps_set_mode(void *service, audio_mode_t mode, int unknown);
+int aps_set_fm_volume(void *service, float volume, int delay_ms);
+#endif
 };
 
 namespace {
@@ -1073,6 +1091,10 @@ namespace {
         .load_hw_module        = aps_load_hw_module,
         .open_output_on_module = aps_open_output_on_module,
         .open_input_on_module  = aps_open_input_on_module,
+#ifdef HAVE_MIUI_AUDIO_BLOB
+        .set_mode              = aps_set_mode,
+        .set_fm_volume         = aps_set_fm_volume,
+#endif
     };
 }; // namespace <unnamed>
 
diff --git a/services/audiopolicy/AudioPolicyService.h b/services/audiopolicy/AudioPolicyService.h
index fe2a3f6..7ec880d 100644
--- a/frameworks/av/services/audiopolicy/AudioPolicyService.h
+++ b/frameworks/av/services/audiopolicy/AudioPolicyService.h
@@ -162,6 +162,10 @@ public:
     virtual status_t stopTone();
     virtual status_t setVoiceVolume(float volume, int delayMs = 0);
     virtual bool isOffloadSupported(const audio_offload_info_t &config);
+#ifdef HAVE_MIUI_AUDIO_BLOB
+    virtual status_t setMode(audio_mode_t mode, int unknown = 0);
+    virtual status_t setFmVolume(float volume, int delayMs = 0);
+#endif
 
     virtual status_t listAudioPorts(audio_port_role_t role,
                                     audio_port_type_t type,
commit 699cc0af1e190957dc3e7d1ce9ea0892a7bd41d6
Author: Xuefer <xuefer@gmail.com>
Date:   Wed Mar 4 00:01:00 2015 +0800

    MIUI audio blob compatibility
    
    Change-Id: I7370dac5a9b0305587af8a5dfa785f6151d3b8da

diff --git a/include/hardware/audio.h b/include/hardware/audio.h
index c3cb740..2684e3e 100644
--- a/hardware/libhardware/include/hardware/audio.h
+++ b/hardware/libhardware/include/hardware/audio.h
@@ -700,6 +700,11 @@ struct audio_hw_device {
      */
     int (*get_master_mute)(struct audio_hw_device *dev, bool *mute);
 
+#ifdef HAVE_MIUI_AUDIO_BLOB
+    /** MIUI blob, set fm volume */
+    int (*set_fm_volume)(struct audio_hw_device *dev, float volume, int delay_ms);
+#endif
+
     /**
      * Routing control
      */
diff --git a/include/hardware/audio_policy.h b/include/hardware/audio_policy.h
index 99cb044..8cb84b2 100644
--- a/hardware/libhardware/include/hardware/audio_policy.h
+++ b/hardware/libhardware/include/hardware/audio_policy.h
@@ -406,6 +406,16 @@ struct audio_policy_service_ops {
                                     audio_format_t *pFormat,
                                     audio_channel_mask_t *pChannelMask);
 
+#ifdef HAVE_MIUI_AUDIO_BLOB
+    int (*set_mode)(void *service,
+                    audio_mode_t mode,
+                    int unknown);
+
+    int (*set_fm_volume)(void *service,
+                         float volume,
+                         int delay_ms);
+#endif
+
 };
 
 /**********************************************************************/
commit 23787476a8059628287200a6b73d22944e160ba0
Author: Xuefer <xuefer@gmail.com>
Date:   Mon Mar 16 02:02:15 2015 +0800

    pre-lollipop-audio-blob: fix compatibility of pcm_param
    
    enum value changes pcm_param, define HAVE_PRE_LOLLIPOP_AUDIO_BLOB to work with old audio blobs
    
    Change-Id: Ia9d15e4613f7a7fcb1422ee001ca9187af6575be

diff --git a/include/tinyalsa/asoundlib.h b/include/tinyalsa/asoundlib.h
index 75e5cda..64bd917 100644
--- a/external/tinyalsa/include/tinyalsa/asoundlib.h
+++ b/external/tinyalsa/include/tinyalsa/asoundlib.h
@@ -115,10 +115,12 @@ struct pcm_config {
 /* PCM parameters */
 enum pcm_param
 {
+#ifndef HAVE_PRE_LOLLIPOP_AUDIO_BLOB
     /* mask parameters */
     PCM_PARAM_ACCESS,
     PCM_PARAM_FORMAT,
     PCM_PARAM_SUBFORMAT,
+#endif
     /* interval parameters */
     PCM_PARAM_SAMPLE_BITS,
     PCM_PARAM_FRAME_BITS,
@@ -132,6 +134,12 @@ enum pcm_param
     PCM_PARAM_BUFFER_SIZE,
     PCM_PARAM_BUFFER_BYTES,
     PCM_PARAM_TICK_TIME,
+#ifdef HAVE_PRE_LOLLIPOP_AUDIO_BLOB
+    /* mask parameters */
+    PCM_PARAM_ACCESS,
+    PCM_PARAM_FORMAT,
+    PCM_PARAM_SUBFORMAT,
+#endif
 };
 
 /* Mixer control types */
commit 3e9fdec31cabba5457e568b3e16ba3837e474268
Author: Xuefer <xuefer@gmail.com>
Date:   Wed Apr 8 13:54:02 2015 +0800

    miui-audio: adds tlv
    
    Change-Id: I290f239b459de4eb1a8d91744e53e7cc3d673d15

diff --git a/mixer.c b/mixer.c
index 4568cca..95ad4aa 100644
--- a/external/tinyalsa/mixer.c
+++ b/external/tinyalsa/mixer.c
@@ -44,15 +44,28 @@
 
 #include <tinyalsa/asoundlib.h>
 
+#ifdef MIUI_AUDIO_BLOB
+struct mixer_tlv {
+    int type;
+    int size;
+    int tlvdata[1]; /* sizeof(tlvdata) == size */
+}
+#endif
 struct mixer_ctl {
     struct mixer *mixer;
     struct snd_ctl_elem_info *info;
     char **ename;
+#ifdef MIUI_AUDIO_BLOB
+    mixer_tlv *tlv;
+#endif
 };
 
 struct mixer {
     int fd;
     struct snd_ctl_card_info card_info;
+#ifdef MIUI_AUDIO_BLOB
+    int miui_unknown;
+#endif
     struct snd_ctl_elem_info *elem_info;
     struct mixer_ctl *ctl;
     unsigned int count;
commit 73528dfe83fd0e4fd1e0c95fe26e394ae732e868
Author: Xuefer <xuefer@gmail.com>
Date:   Wed Mar 4 00:01:12 2015 +0800

    miui-fm
    
    Change-Id: Id68a14b35c3fa9f521fcace061befa580589c1fa

diff --git a/audio/AudioPolicyCompatClient.cpp b/audio/AudioPolicyCompatClient.cpp
index 9d02d98..5fe0b87 100644
--- a/hardware/libhardware_legacy/audio/AudioPolicyCompatClient.cpp
+++ b/hardware/libhardware_legacy/audio/AudioPolicyCompatClient.cpp
@@ -144,4 +144,16 @@ status_t AudioPolicyCompatClient::setVoiceVolume(float volume, int delayMs)
     return mServiceOps->set_voice_volume(mService, volume, delayMs);
 }
 
+#ifdef HAVE_MIUI_AUDIO_BLOB
+status_t AudioPolicyCompatClient::setMode(audio_mode_t mode, int unknown)
+{
+    return mServiceOps->set_mode(mService, mode, unknown);
+}
+
+status_t AudioPolicyCompatClient::setFmVolume(float volume, int delayMs)
+{
+    return mServiceOps->set_fm_volume(mService, volume, delayMs);
+}
+#endif
+
 }; // namespace android_audio_legacy
diff --git a/audio/AudioPolicyCompatClient.h b/audio/AudioPolicyCompatClient.h
index 19f76e1..27ab4d0 100644
--- a/hardware/libhardware_legacy/audio/AudioPolicyCompatClient.h
+++ b/hardware/libhardware_legacy/audio/AudioPolicyCompatClient.h
@@ -73,6 +73,11 @@ public:
     virtual status_t stopTone();
     virtual status_t setVoiceVolume(float volume, int delayMs = 0);
 
+#ifdef HAVE_MIUI_AUDIO_BLOB
+    virtual status_t setMode(audio_mode_t mode, int);
+    virtual status_t setFmVolume(float volume, int delayMs = 0);
+#endif
+
 private:
     struct audio_policy_service_ops* mServiceOps;
     void*                            mService;
diff --git a/include/hardware_legacy/AudioPolicyInterface.h b/include/hardware_legacy/AudioPolicyInterface.h
index da03ee3..bbd4aaa 100644
--- a/hardware/libhardware_legacy/include/hardware_legacy/AudioPolicyInterface.h
+++ b/hardware/libhardware_legacy/include/hardware_legacy/AudioPolicyInterface.h
@@ -250,6 +250,10 @@ public:
                                      audio_io_handle_t srcOutput,
                                      audio_io_handle_t dstOutput) = 0;
 
+#ifdef HAVE_MIUI_AUDIO_BLOB
+    virtual status_t setMode(audio_mode_t, int) = 0;
+    virtual status_t setFmVolume(float volume, int delayMs = 0) = 0;
+#endif
 };
 
 extern "C" AudioPolicyInterface* createAudioPolicyManager(AudioPolicyClientInterface *clientInterface);
